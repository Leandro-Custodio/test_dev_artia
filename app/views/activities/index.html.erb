<% content_for :title, "Activities" %>

<div class="p-4 space-y-4">
  <h1 class="text-2xl font-bold text-gray-800">Atividades</h1>

  <% if notice.present? %>
    <p class="text-green-600 font-medium"><%= notice %></p>
  <% end %>

  <div class="flex justify-between items-center mb-4">
    <%= link_to "Nova atividade", new_activity_path, class: "px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition" %>
    <button id="open-filter-modal" class="px-4 py-2 border border-gray-300 hover:border-gray-400 text-gray-700 rounded-lg transition">Filtrar</button>
  </div>

  <div class="overflow-x-auto rounded-lg shadow border">
    <table class="min-w-full text-sm text-left">
      <thead class="bg-gray-100">
        <tr>
          <% ["ID", "Título", "Descrição", "Status", "Início", "Término", "Tipo", "% Completo", "Prioridade", "Urgência", "Pontos", "Responsável", "Ações"].each do |header| %>
            <th class="px-4 py-2 font-medium text-gray-700"><%= header %></th>
          <% end %>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @activities.each do |activity| %>
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2"><%= activity.id %></td>
            <td class="px-4 py-2"><%= activity.title %></td>
            <td class="px-4 py-2"><%= truncate(activity.description, length: 50) %></td>
            <td class="px-4 py-2"><%= activity.status ? '✅' : '❌' %></td>
            <td class="px-4 py-2"><%= activity.start_date %></td>
            <td class="px-4 py-2"><%= activity.end_date %></td>
            <td class="px-4 py-2"><%= activity.kind_value %></td>
            <td class="px-4 py-2"><%= activity.completed_percent %> %</td>
            <td class="px-4 py-2"><%= activity.priority %></td>
            <td class="px-4 py-2"><%= activity.urgency_value %></td>
            <td class="px-4 py-2"><%= activity.points %></td>
            <td class="px-4 py-2"><%= activity.user_id %></td>
            <td class="px-4 py-2 space-x-2">
              <%= link_to 'Show', activity, class: "text-blue-600 hover:underline" %>
              <%= link_to 'Edit', edit_activity_path(activity), class: "text-yellow-600 hover:underline" %>
              <%= link_to 'Delete', activity, method: :delete, data: { confirm: 'Tem certeza?' }, class: "text-red-600 hover:underline" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="filter-modal" class="fixed inset-0 bg-gray-900 opacity-100 hidden justify-center z-50 p-6" style="overflow: auto; position: absolute;">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl p-4 space-y-4 " style="height: fit-content;">
    <h2 class="text-lg font-semibold text-gray-800">Filtros Avançados</h2>
    <form action="<%= activities_path %>" method="get" class="space-y-4 bg-white">
      <input type="hidden" name="filter_mode" value="advanced">

      <div>
        <label class="block text-gray-700 font-medium mb-1">Operação entre grupos:</label>
        <select name="group_operator" class="form-select border border-gray-300 rounded-lg px-3 py-2">
          <option value="and" <%= 'selected' if params[:group_operator] == 'and' %>>E (AND)</option>
          <option value="or" <%= 'selected' if params[:group_operator] == 'or' %>>OU (OR)</option>
        </select>
      </div>

      <% 4.times do |group_index| %>
        <% group = params.dig(:filters, group_index.to_s) || {} %>
        <% group_operator = group[:operator] %>

        <fieldset class="border border-gray-200 rounded-lg p-4 space-y-2">
          <legend class="text-gray-700 font-medium">Grupo <%= group_index + 1 %></legend>

          <div class="mb-3">
            <label class="block text-gray-600 font-medium mb-1">Operação entre filtros do grupo:</label>
            <select name="filters[<%= group_index %>][operator]" class="form-select border border-gray-300 rounded-lg px-3 py-2">
              <option value="and" <%= 'selected' if group_operator == 'and' %>>E (AND)</option>
              <option value="or" <%= 'selected' if group_operator == 'or' %>>OU (OR)</option>
            </select>
          </div>

          <% 4.times do |filter_index| %>
            <% condition = group.dig(:conditions, filter_index.to_s) || {} %>
            <% field = condition[:field] %>
            <% value = condition[:value] %>

            <div class="grid grid-cols-2 gap-4 mb-3">
              <select name="filters[<%= group_index %>][conditions][<%= filter_index %>][field]" class="form-select border border-gray-300 rounded-lg px-3 py-2">
                <option value="">Selecione campo</option>
                <option value="title" <%= 'selected' if field == 'title' %>>Título</option>
                <option value="kind" <%= 'selected' if field == 'kind' %>>Tipo</option>
                <option value="urgency" <%= 'selected' if field == 'urgency' %>>Urgência</option>
                <option value="user_id" <%= 'selected' if field == 'user_id' %>>Responsável</option>
                <option value="priority" <%= 'selected' if field == 'priority' %>>Prioridade</option>
              </select>
              <input name="filters[<%= group_index %>][conditions][<%= filter_index %>][value]" class="form-input border border-gray-300 rounded-lg px-3 py-2" placeholder="Valor" value="<%= value %>" />
            </div>
          <% end %>
        </fieldset>
      <% end %>

      <div class="flex justify-end gap-4 pt-2 p-4">
        <button type="button" id="close-filter-modal" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Aplicar Filtros</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById("filter-modal");
    const openBtn = document.getElementById('open-filter-modal');
    const closeBtn = document.getElementById('close-filter-modal');

    function openModal() {
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  });
</script>