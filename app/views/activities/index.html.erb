<% content_for :title, "Activities" %>

<h1>Atividades</h1>

<p style="color: green"><%= notice %></p>

<div style="margin-bottom: 1em; display: flex; justify-content: space-between">
  <%= link_to "Nova atividade", new_activity_path, class: "btn btn-primary" %>

  <button id="open-filter-modal" class="btn btn-outline-secondary">Filtrar</button>
</div>

<div style="overflow-x: auto; border: 1px solid #ccc; border-radius: 6px;">
  <table style="width: 100%; min-width: 1000px; border-collapse: collapse;">
    <thead style="background-color: #f2f2f2;">
      <tr>
        <th style="padding: 8px; text-align: left;">ID</th>
        <th style="padding: 8px; text-align: left;">Título</th>
        <th style="padding: 8px; text-align: left;">Descrição</th>
        <th style="padding: 8px; text-align: left;">Status</th>
        <th style="padding: 8px; text-align: left;">Início</th>
        <th style="padding: 8px; text-align: left;">Término</th>
        <th style="padding: 8px; text-align: left;">Tipo</th>
        <th style="padding: 8px; text-align: left;">% Completo</th>
        <th style="padding: 8px; text-align: left;">Prioridade</th>
        <th style="padding: 8px; text-align: left;">Urgência</th>
        <th style="padding: 8px; text-align: left;">Pontos</th>
        <th style="padding: 8px; text-align: left;">Responsável</th>
        <th style="padding: 8px; text-align: left;">Ações</th>
      </tr>
    </thead>
    <tbody>
      <% @activities.each do |activity| %>
        <tr style="border-top: 1px solid #ddd;">
          <td style="padding: 8px;"><%= activity.id %></td>
          <td style="padding: 8px;"><%= activity.title %></td>
          <td style="padding: 8px;"><%= truncate(activity.description, length: 50) %></td>
          <td style="padding: 8px;"><%= activity.status ? '✅' : '❌' %></td>
          <td style="padding: 8px;"><%= activity.start_date %></td>
          <td style="padding: 8px;"><%= activity.end_date %></td>
          <td style="padding: 8px;"><%= activity.kind_value %></td>
          <td style="padding: 8px;"><%= activity.completed_percent %> %</td>
          <td style="padding: 8px;"><%= activity.priority %></td>
          <td style="padding: 8px;"><%= activity.urgency_value %></td>
          <td style="padding: 8px;"><%= activity.points %></td>
          <td style="padding: 8px;"><%= activity.user_id %></td>
          <td style="padding: 8px;">
            <%= link_to 'Show', activity, style: "margin-right: 6px;" %>
            <%= link_to 'Edit', edit_activity_path(activity), style: "margin-right: 6px;" %>
            <%= link_to 'Delete', activity, method: :delete, data: { confirm: 'Tem certeza?' }, style: "color: red;" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div id="filter-modal" style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
  <div style="background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px;">

    <h2>Filtros Avançados</h2>

    <form action="<%= activities_path %>" method="get">
      <input type="hidden" name="filter_mode" value="advanced">

      <!-- Operação entre grupos -->
      <div style="margin-bottom: 1em;">
        <label>Operação entre grupos:</label>
        <select name="group_operator" class="form-select" style="width: auto; display: inline-block;">
          <option value="and" <%= 'selected' if params[:group_operator] == 'and' %>>E (AND)</option>
          <option value="or" <%= 'selected' if params[:group_operator] == 'or' %>>OU (OR)</option>
        </select>
      </div>

      <% 4.times do |group_index| %>
        <% group = params.dig(:filters, group_index.to_s) || {} %>
        <% group_operator = group[:operator] %>

        <fieldset style="margin-bottom: 1.5em; border: 1px solid #ccc; padding: 1em;">
          <legend>Grupo <%= group_index + 1 %></legend>

          <!-- Operação entre filtros do grupo -->
          <div style="margin-bottom: 1em;">
            <label>Operação entre filtros do grupo:</label>
            <select name="filters[<%= group_index %>][operator]" class="form-select" style="width: auto; display: inline-block;">
              <option value="and" <%= 'selected' if group_operator == 'and' %>>E (AND)</option>
              <option value="or" <%= 'selected' if group_operator == 'or' %>>OU (OR)</option>
            </select>
          </div>

          <% 4.times do |filter_index| %>
            <% condition = group.dig(:conditions, filter_index.to_s) || {} %>
            <% field = condition[:field] %>
            <% value = condition[:value] %>

            <div class="row mb-2">
              <div class="col">
                <select name="filters[<%= group_index %>][conditions][<%= filter_index %>][field]" class="form-select">
                  <option value="">Selecione campo</option>
                  <option value="title" <%= 'selected' if field == 'title' %>>Título</option>
                  <option value="kind" <%= 'selected' if field == 'kind' %>>Tipo</option>
                  <option value="urgency" <%= 'selected' if field == 'urgency' %>>Urgência</option>
                  <option value="user_id" <%= 'selected' if field == 'user_id' %>>Responsável</option>
                  <option value="priority" <%= 'selected' if field == 'priority' %>>Prioridade</option>
                </select>
              </div>
              <div class="col">
                <input name="filters[<%= group_index %>][conditions][<%= filter_index %>][value]" class="form-control" placeholder="Valor" value="<%= value %>" />
              </div>
            </div>
          <% end %>
        </fieldset>
      <% end %>

      <div style="display: flex; justify-content: flex-end; gap: 1em;">
        <button type="button" id="close-filter-modal" class="btn btn-secondary">Cancelar</button>
        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
      </div>
    </form>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('filter-modal');
    const openBtn = document.getElementById('open-filter-modal');
    const closeBtn = document.getElementById('close-filter-modal');

    openBtn.addEventListener('click', () => {
      modal.style.display = 'block';
    });

    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    });
  });
</script>